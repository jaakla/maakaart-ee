#summary Üldinfo meie serverite osas.

= Serverid =

  # Live: kaart.maakaart.ee. 16G RAM, 4.5T ketast kokku, 8-core. Ubuntu 11.04 hetkel
  # Test: 193.40.61.100 4G RAM
  # Juniperi ruuter/tulemüür live-serveri ees.

= Tarkvara =
  # liveserveri üldjoonis: https://docs.google.com/drawings/d/1HGTn47iCXx4u17ZD3-FuSAXXMdwp4STH3OpoUr3ycr0/edit
  # vaata detailse konfi osas siinseid wiki lehti

== Bittorrent OSM Planet-ile ==
  * jookseb kasutaja jaakl screen-i sees käsuga. Skripti pole, käsitsi restartida korra nädalas et oleks uuem. Käsitsi kustutada vanad planet failid 
{{{
sudo su -u jaakl
screen -RRD
cd /home/jaakl
rtorrent http://osm-torrent.torres.voyager.hr/files/planet-latest.osm.bz2.torrent -p 6881-6881
}}}
  * Juniperis on selle jaoks suunatud 6881 port sisse

== Imposm ==
  * kasutatakse mapserveri poolt WMS-i APIs.
  * kompileeritud sourcest */opt/imposm* kataloogis lähtudes http://wiki.osgeo.org/wiki/Benchmarking_2011/Imposm juhendist
  * tekitab vahefailidena .cache failid, mis planeedi puhul võtavad kokku umbes 13GB. Nt kodukataloogis ei saa käivitada seetõttu
  * vaikimisi konf impordib place kihis vaid name-tagi, seega eestikeelse jaoks on vaja impordikonfi modida (lisada "name:et") ja importida uuesti ning modida kujundusfaili (.map faili)
  * loo ja käivita andmebaas:
{{{
sudo mkdir /suur/imposmdata/
sudo chown postgres /suur/imposmdata/
sudo su postgres
initdb -D /suur/imposmdata/
nano /suur/imposmdata/postgresql.conf
 port = 5433
 shared_buffers = 128MB # 16384 for 8.1 and earlier
 checkpoint_segments = 20
 maintenance_work_mem = 256MB # 256000 for 8.1 and earlier
 autovacuum = off

postgres -D /suur/imposmdata/
pg_ctl start -D /storage/suur/data/
createdb osm -p 5433 -h localhost
psql -d osm -p 5433  -h localhost -f /usr/share/postgresql/contrib/postgis-1.5/postgis.sql
psql -d osm -p 5433  -h localhost -f /usr/share/postgresql/contrib/postgis-1.5/spatial_ref_sys.sql
}}}
  * käivitatud järgnev käivitatud kasutaja _postgres_ alt. See võttis aega ~9h lugemine, + ~29h baasi kirjutamine ja optimeerimine:
{{{
cd /home/jaakl/imposm_data
export LD_LIBRARY_PATH=/opt/imposm/lib
imposm --read --write --optimize --deploy-production-tables -d osm -m ../custommapping.py -p 5433 -c 4 /home/jaakl/planet-111026.osm.bz2
}}}
  * Täiendatud impordi konfi (/home/jaakl/custommaping.py), et eestikeelsed kohanimed oleksid ja hoonetel majanumbrid, ning andmebaasiühendused:
{{{
db_conf = Options(
    # db='osm',
    host='localhost',
    port=5433,
    user='postgres',
    password='',
    sslmode='allow',
    prefix='osm_new_',
    proj='epsg:3857',
)

...
set_default_name_type(LocalizedName(['name:et', 'int_name', 'name:en', 'name']))
...
buildings = Polygons(
    name = 'buildings',
    fields = (
        ('addr:housenumber', String()),
    ),
    mapping = {
        'building': (
            '__any__',
    )}
)

}}}

== Mapserver ==
  * Installitud apt-get paketist
  * Konf */opt/mapserver* kataloogis
  * Binary on */usr/lib/cgi-bin* kaustas, apache oskab seda sealt leida
  * URL wrapper */usr/lib/cgi-bin/wms* on ise lisatud, see sisaldab viidet .map failile (kujundusega).
  * avalik WMS URL: http://kaart.maakaart.ee/cgi-bin/wms . NB! see on aeglane, avalikult kasutada tuleks Mapproxy URL-i.
  * Täiendusidee: installida mapproxy et teha seda oluliselt kiiremaks, ka madalate zoomide juures.

== Mapproxy ==
  * conf: /opt/mapproxy/ kataloogis, vt MapProxyConf. Konfitud lokaalset mapserveri WMS kasutama + katseks Maaameti WMS (ei pruugi toimida täielikult)
  * Testserveri käivitamine: 
{{{
sudo su -u jaakl
screen -RRD
cd /opt/mapproxy
mapproxy-util serve-develop mapproxy.yaml
}}}
  * live conf Apache mod_wsgi abil, vastavalt mapproxy manuaalile deploytud. Apache konfis teenuse URL on /osm, aga töötab ka /service ja /tiles läbi URL rewrite:
{{{
        # mapproxy forward short URL-s
        RewriteEngine on
        RewriteRule   ^/service$  /osm/service [PT]
        RewriteRule   ^/tiles/(.*)$  /osm/tiles/$1 [PT]

        # tileproxy in wsgi
        WSGIScriptAlias /osm /opt/mapproxy/config.py

        <Directory /opt/mapproxy/>
                Order deny,allow
                Allow from all
        </Directory>
}}}
  * Live logid: */var/log/mapproxy* . Erroreid tasub otsida ka Apache error.log failist.
  * konfitud on ka seedfail mis madalamaid zoome pregenereerib cache sisse. Kasutamine:
{{{
cd /opt/mapproxy
mapproxy-seed -f mapproxy.yaml -c 1 seed.yaml
}}}
  * Avalik OSM WMS URL: http://kaart.maakaart.ee/service
  * Avalik Maaameti ortopiltide tile url kasutamiseks Potlatch2 sees:
 {{{
http://kaart.maakaart.ee/tiles/1.0.0/maaamet_orto_EPSG900913/$z/$x/$y.jpeg?origin=nw
}}}