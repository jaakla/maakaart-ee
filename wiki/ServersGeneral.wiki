#summary Üldinfo meie serverite osas, installatsiooni logi

= Serverid =
  # Live: kaart.maakaart.ee; toimivad ka aliased stiilis (a/b/c/misiganes).kaart.maakaart.ee. 16G RAM, 8 ketast kokku, 8-core. Ubuntu 11.10 (viimane) server
   kettad (RAID kontrolleri taga):
    a) 2x500GB SATA kettad, RAID-1 (mirror)
       / - 442GB
    b) 2x148 GB SAS ketast RAID-0 (stripe)
      /storage - kiire IO. Siin imposm planeet baas Mapserveri jaoks (osm), postgres port 5432.

    c) - 4x1GB, riistvara RAID-10, 2TB saadaval
      /suur  - kaardiandmete, tilede, muude baaside jms jaoks. Siin on osm2pgsql Mapnik baas (gis), veel üks imposm planeet testiks (osm) ja Eesti imposm testbaas (osmee), postgres port 5433.

   võrgukonf: staatiline lan ip 192.168.1.100. Suunatud tulemüürist. IMPI management saadaval.

  # Testserver: 193.40.61.99 4G RAM. Siin on näiteks ADS baas.
  # Juniperi ruuter/tulemüür live-serveri ees. Väline IP: 193.40.61.100

= Tarkvara =
  # liveserveri üldjoonis: https://docs.google.com/drawings/d/1HGTn47iCXx4u17ZD3-FuSAXXMdwp4STH3OpoUr3ycr0/edit
  # vaata detailse konfi osas siinseid wiki lehti

== Bittorrent OSM Planet-ile ==
  * jookseb kasutaja jaakl screen-i sees käsuga. Skripti pole, käsitsi restartida korra nädalas et oleks uuem. Käsitsi kustutada vanad planet failid 
{{{
sudo su -u jaakl
screen -RRD
cd /home/jaakl
rtorrent http://osm-torrent.torres.voyager.hr/files/planet-latest.osm.bz2.torrent -p 6881-6881
}}}
  * Juniperis on selle jaoks suunatud 6881 port sisse

== Imposm ==
=== Planet ===
  * kasutatakse mapserveri poolt WMS-i APIs.
  * kompileeritud sourcest */opt/imposm* kataloogis lähtudes http://wiki.osgeo.org/wiki/Benchmarking_2011/Imposm juhendist
  * tekitab vahefailidena .cache failid, mis planeedi puhul võtavad kokku umbes 13GB. Nt kodukataloogis ei saa käivitada seetõttu
  * vaikimisi konf impordib place kihis vaid name-tagi, seega eestikeelse jaoks on vaja impordikonfi modida (lisada "name:et") ja importida uuesti ning modida kujundusfaili (.map faili)
  * kerneli konfi parandus:
{{{
sudo sh -c "echo 'kernel.shmmax=268435456' > /etc/sysctl.d/60-shmmax.conf
sudo service procps start
}}}
  * loo ja käivita andmebaas:
{{{
sudo mkdir /storage/imposmdb
sudo chown postgres /storage/imposmdb
sudo su postgres
initdb -D /storage/imposmdb/
nano /storage/imposmdb/postgresql.conf
 port = 5432
 shared_buffers = 128MB # 16384 for 8.1 and earlier
 checkpoint_segments = 20
 maintenance_work_mem = 256MB # 256000 for 8.1 and earlier
 autovacuum = off
 unix_socket_directory = '/tmp'
postgres -D /storage/imposmdb/
pg_ctl start -D /storage/imposmdb/
createdb osm -p 5432 -h localhost
psql -d osm -p 5432  -h localhost -f /usr/share/postgresql/contrib/postgis-1.5/postgis.sql
psql -d osm -p 5432  -h localhost -f /usr/share/postgresql/contrib/postgis-1.5/spatial_ref_sys.sql
}}}
  * käivitatud järgnev käivitatud kasutaja _postgres_ alt. See võttis aega ~9h lugemine, + ~29h baasi kirjutamine ja optimeerimine:
{{{
cd /home/jaakl/imposm_data
export LD_LIBRARY_PATH=/opt/imposm/lib
imposm --read --write --optimize --deploy-production-tables -d osm -m ../custommapping.py -p 5432 -c 4 /home/jaakl/planet-111123.osm.bz2
}}}
  * Täiendatud impordi konfi (/home/jaakl/custommaping.py), et eestikeelsed kohanimed oleksid ja hoonetel majanumbrid, ning andmebaasiühendused:
{{{
db_conf = Options(
    # db='osm',
    host='localhost',
    port=5432,
    user='postgres',
    password='',
    sslmode='allow',
    prefix='osm_new_',
    proj='epsg:3857',
)

...
set_default_name_type(LocalizedName(['name:et', 'int_name', 'name:en', 'name']))
...
buildings = Polygons(
    name = 'buildings',
    fields = (
        ('addr:housenumber', String()),
    ),
    mapping = {
        'building': (
            '__any__',
    )}
)

}}}

  * Õigused www-data kasutajale baasist andmeid pärida:
{{{
sudo -u postgres psql -p 5432 osm
psql (9.0.3, server 9.0.2)
Type "help" for help.
osm=# CREATE ROLE "www-data" LOGIN;
osm=# GRANT SELECT ON ALL TABLES IN SCHEMA public TO "www-data";
GRANT
osm=# \q
}}}

=== Eesti (kiiremaks testimiseks) ===
{{{
sudo su postgres
createdb osmee
psql -d osmee -f /usr/share/postgresql/contrib/postgis-1.5/postgis.sql
psql -d osmee -f /usr/share/postgresql/contrib/postgis-1.5/spatial_ref_sys.sql
exit
cd /home/jaakl
mkdir imposm_dataee
wget http://download.geofabrik.de/osm/europe/estonia.osm.bz2
export LD_LIBRARY_PATH=/opt/imposm/lib
imposm --read --write --optimize --deploy-production-tables -d osmee  -m ../custommapping.py -c 4 estonia.osm.bz2
sudo -u postgres psql osmee
GRANT SELECT ON ALL TABLES IN SCHEMA public TO "www-data";
\q
}}}
  * imposm import võttis umbes 3 minutit, download umbes 5 minutit.
  * moditud kujundusfail : /opt/mapserver/osm-google-est.map
     # _Kõikidel kihtidel:_ *CONNECTION "dbname=osmee port=5432"*
     # Kommenteeri välja: #"ows_onlineresource"      "http://kaart.maakaart.ee/cgi-bin/mapserv?MAP=/opt/mapserver/osm-google-est.map&"
  * WMS URL: http://kaart.maakaart.ee/cgi-bin/mapserv?MAP=/opt/mapserver/osm-google-est.map&

== Mapserver ==
  * Installitud *sudo apt-get install cgi-mapserver*
  * Konf */opt/mapserver* kataloogis, kujundus */opt/mapserver/osm-google-p5432.map*
  * Binary on */usr/lib/cgi-bin* kaustas, apache oskab seda sealt leida
  * proj confile google projection lisada faili */usr/share/proj/epsg*
{{{
#Google Web map SRS defs
<900913> +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs
<3857> +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs
}}} 
  * URL wrapper */usr/lib/cgi-bin/wms* on ise lisatud, see sisaldab viidet .map failile (kujundusega).
{{{
#!/bin/sh
MAPSERV="/usr/lib/cgi-bin/mapserv"
MS_MAPFILE="/opt/mapserver/osm-google-p5432.map" exec ${MAPSERV}
}}}

  * avalik WMS URL: http://kaart.maakaart.ee/cgi-bin/wms . NB! see on aeglane, avalikult kasutada tuleks Mapproxy URL-i, vt järgmine ptk

== Mapproxy ==
  * install: *sudo pip install MapProxy*
  * conf: /opt/mapproxy/ kataloogis, vt MapProxyConf. Konfitud lokaalset mapserveri WMS kasutama + katseks Maaameti WMS (ei pruugi toimida täielikult). Tilede cache jaoks kataloog:
{{{
sudo mkdir /suur/mapproxy_cache
sudo chmod a+w /suur/mapproxy_cache
}}}
  * Testserveri käivitamine: 
{{{
sudo su -u jaakl
screen -RRD
cd /opt/mapproxy
mapproxy-util serve-develop mapproxy.yaml
}}}
  * live conf Apache mod_wsgi abil, vastavalt mapproxy manuaalile deploytud. Apache konfis */etc/apache2/sites-available/default* määratud teenuse URL on /osm, aga töötab ka /service ja /tiles läbi URL rewrite:
{{{
        # mapproxy forward short URL-s
        RewriteEngine on
        RewriteRule   ^/service$  /osm/service [PT]
        RewriteRule   ^/tiles/(.*)$  /osm/tiles/$1 [PT]

        # tileproxy in wsgi
        WSGIScriptAlias /osm /opt/mapproxy/config.py

        <Directory /opt/mapproxy/>
                Order deny,allow
                Allow from all
        </Directory>
}}}
  * Live logid: */var/log/mapproxy* . Erroreid tasub otsida ka Apache error.log failist.
  * konfitud on ka seedfail mis madalamaid zoome pregenereerib cache sisse. Kasutamine:
{{{
cd /opt/mapproxy
sudo -u www-data mapproxy-seed -f mapproxy.yaml -c 1 seed.yaml
}}}
  * Avalik OSM WMS URL: http://kaart.maakaart.ee/service
  * Avalik Maaameti ortopiltide tile url kasutamiseks Potlatch2 sees:
 {{{
http://kaart.maakaart.ee/tiles/1.0.0/maaamet_orto_EPSG900913/$z/$x/$y.jpeg?origin=nw
}}}

=Mapniku-põhine kaart=
==osm2pgsql==
  * Loo uus postgis baas '*gis*' 5433 pordis olevasse baasi (/suur/imposmdata kataloogis cluster). Vt eespool käske
  * aktiveeri seal ka hstore extension, PostGres 9.0+ käib see SQL asemel järgnevalt:
{{{
psql -p 5433 gis
create extension hstore;
}}}   
  * kompileeri osm2pgsql - viimane svn versioon
{{{
mkdir /opt/osm2pgsql/src
cd /opt/osm2pgsql/src
svn co http://svn.openstreetmap.org/applications/utils/export/osm2pgsql/
cd osm2pgsql/
./autogen.sh
./configure
sed -i 's/-g -O2/-O2 -march=native -fomit-frame-pointer/' Makefile
make
}}}
  * Käivita import kasutades kiiret lahtipakkimise meetodit. Täisplaneedi kogu import võttis ikkagi vähemalt 5 ööpäeva.
{{{
cd  /opt/osm2pgsql/src/osm2pgsql
bunzip2 -c /home/jaakl/planet-111123.osm.bz2 |./osm2pgsql --slim -d gis -U postgres --hstore -C 10000 --number-processes=4 -P 5433 /dev/stdin
}}}

==Mapnik ja Mod_tile==
Kasutan https://launchpad.net/~kakrueger/+ppa-packages ubuntu pakette.
{{{
sudo add-apt-repository ppa:kakrueger/openstreetmap
sudo apt-get update
sudo apt-get install apache2-dev
sudo apt-get install renderd
sudo apt-get install libapache2-mod-tile
sudo apt-get install unifont
}}}
Tulemus:
  # paketiga tulev layout ja shapefailid on koondatud */etc/mapnik-osm-data/osm.xml*
  # see on libmapnik 0.7.1, mis töötab Mapnik kujundusega ilma seda konvertimata

Lisasammud:
  # kustuta pakitud failid /etc/mapnik-osm-data/ kataloogist, vabastad sadu megabaite:
{{{
cd /etc/mapnik-osm-data/
sudo rm *bz2
sudo rm *tgz
sudo rm *zip
}}}
  # tõsta failid suuremale storagele, tee symlink tagasi
{{{
sudo cp /etc/mapnik-osm-data /suur/mapnik-osm-data/
sudo rm -rf /etc/mapnik-osm-data
sudo ln -s /suur/mapnik-osm-data /etc
}}}
  # kombineeri apache konfides default ja tileserver_site konfid, kontrolli ega path-is konflikte pole
  # suurenda apache konfifailis aegu mis on tile genereerimiseks lubatud, muidu tuleb vähemalt esialgu liiga palju 404 not found.
  # konfi /etc/renderd.conf, lisa est töötav kujundus, muuda fontide otsingut et unifont leitaks, määra path-id
{{{
[renderd]
stats_file=/var/run/renderd/renderd.stats
socketname=/var/run/renderd/renderd.sock
num_threads=4
tile_dir=/var/lib/mod_tile ; DOES NOT WORK YET

[mapnik]
plugins_dir=/usr/lib/mapnik/0.7/input
font_dir=/usr/share/fonts/truetype/
font_dir_recurse=true

[default]
URI=/modtile/default/
XML=/etc/mapnik-osm-data/osm.xml
;HOST=tile.openstreetmap.org
;HTCPHOST=proxy.openstreetmap.org

[est]
URI=/modtile/est/
XML=/home/mapnik/mapnik/osm_et.xml
;HOST=tile.openstreetmap.org
;HTCPHOST=proxy.openstreetmap.org
}}}
  # unifont (hiina tähed jms) jaoks modi /etc/mapnik-osm-data/inc/fontset-settings.inc faili
  # Konfi datasource-settings.xml.inc baasi ühendus (port 5433, user postgres). Kõikidel kujundustel.
  # Eestikeelsete kohanimede jaoks inc/layer-placenames_et.xml.inc failis on "name" päritud hstore veerust: _...,COALESCE(tags -> 'name:et',tags -> 'name:en', "name") AS name ..._
  # muuda tilekataloog suuremale storagele:
{{{
sudo service renderd stop
sudo cp -r /var/lib/mod_tile /suur
sudo chown -R www-data /suur/mod_tile
sudo rm -rf /var/lib/mod_tile
sudo ln -s /suur/mod_tile /var/lib
sudo service renderd start

}}}
  # iga kujunduse, renderd.conf ja osm.xml-ide muutmine nõuab nii apache2 kui renderd restarti:
{{{
sudo service renderd restart
sudo service apache2 restart
}}}
  # renderd logi (veateated jms) leiab: /var/log/syslog.1
  # eelrenderda madalad zoomid, eestikeelne Eesti ala detailsemalt:
{{{
render_list -s /var/run/renderd/renderd.sock --all -z 0 -Z 10 -n 4 -m est
render_list -s /var/run/renderd/renderd.sock --all -z 0 -Z 10 -n 4 -m default
render_list -s /var/run/renderd/renderd.sock --all -y 598 -Y 621 -x 1148 -X 1184 -z 11 -Z 11 -n 4 -m est
render_list -s /var/run/renderd/renderd.sock --all -y 1196 -Y 1242 -x 2296 -X 2368 -z 12 -Z 12  -n 4 -m est
render_list -s /var/run/renderd/renderd.sock --all -y 2392 -Y 2484 -x 4592 -X 4736 -z 13 -Z 13  -n 4 -m est
render_list -s /var/run/renderd/renderd.sock --all -y 4784 -Y 4968 -x 9184 -X 9472 -z 14 -Z 14  -n 4 -m est
render_list -s /var/run/renderd/renderd.sock --all -y 9568 -Y 9936 -x 18368 -X 18944 -z 15 -Z 15  -n 4 -m est
render_list -s /var/run/renderd/renderd.sock --all -y 19136 -Y 19872 -x 36736 -X 37888 -z 16 -Z 16  -n 4 -m est
render_list -s /var/run/renderd/renderd.sock --all -y 38272 -Y 39744 -x 73472 -X 75776 -z 17 -Z 17  -n 4 -m est
render_list -s /var/run/renderd/renderd.sock --all -y 76544 -Y 79488 -x 146944 -X 151552 -z 18 -Z 18  -n 4 -m est
}}}

==Mapnik baasi pidev uuendus (minutely mapnik)==
Note: Imposm/Mapserver-i baasi uuendamiseks on täna veel ainus võimalus uus täisimport.

Allolev on peamiselt http://wiki.openstreetmap.org/wiki/DE:Minutely_Mapnik baasil.
  # Installi ja kohanda load-next skript. Siin on minu modifitseeritud [LoadNext load-next] täiskujul.
{{{
cd /opt
svn co https://svn.toolserver.org/svnroot/mazder/diff-import/ diffs
cd diffs
edit load-next
 # set database connections, directories for tools
 # osm2pgsql command modify to add port there, remove unneeded parameters (style, host)
 # tile_exipry/expire.rb (aeglane!) asemel kasutada 10x kiiremat mod_tile-ga tulevat render_expired skripti, ja seda kahe tileseti peal.
}}}
  # Genereeri state.txt, muutes URL-is kuupäev vastavalt viimasele imporditud planeedi ajale.
{{{
wget "http://toolserver.org/~mazder/replicate-sequences/?Y=2011&m=11&d=23&H=01&i=00&s=00&stream=minute" -O state.txt
}}}
  # Esialgu, kui planeet on päevi vanu (minul suisa 30 pv) 1-tunnise intervalliga jooksev uuendus, igas uuenduses on 6 tundi andmeid. Kontrolli konfi ja lisa crontab-i load-next käivitus:
{{{
nano configuration.txt
# 6 hours
maxInterval = 21600

sudo -u jaakl crontab -e
@hourly /opt/diffs/load-next
}}}
  # TODO: kui andmed hakkavad jõudma suhteliselt värskeks (< 1 pv vanaks), siis tuleks vähenda samm-sammult eriti crontabis (maxInterval võib jääda?) uuenduste perioodi, et kiiremad uuendused oleks, kuni 1 minutini välja.
  # load-next toimimist jälgi logidest, peamiselt neist failidest. Enamus aega võtab osm2pgsql baasi lugemine:
{{{
tail /opt/diffs/logs/run.log
tail -f /opt/diffs/logs/osm2pgsql.log
}}}
  # Tekitada webi skript mis näitab uuenduste seisu http://kaart.maakaart.ee/planetstate.php:
{{{
nano /var/www/planetstate.php
<?php
echo "Mapnik database is currently (more than) ";
echo `/opt/diffs/replag -h`;
echo " old.<br/>";
$filename = '/suur/mod_tile/planet-import-complete';
if (file_exists($filename)) {
    echo "$filename was last modified: " . date ("F d Y H:i:s.", filemtime($filename));
}
echo "<br/>";

$statefile = '/opt/diffs/state.txt';
echo $statefile." :<br/><pre>";
echo file_get_contents($statefile);
echo "</pre>";
?>
}}}